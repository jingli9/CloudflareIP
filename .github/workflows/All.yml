name: All

on:
  push:              
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true

      - name: Run script and save output
        run: |
          python py/All.py > All.txt

      - name: Commit result
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add All.txt
          git commit -m "Auto update All.txt [skip ci]" || echo "No changes to commit"
          git push

      - name: Send All.txt to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          FILE="All.txt"
          NOW=$(date "+%Y-%m-%d %H:%M:%S")
          # ä½¿ç”¨ MarkdownV2 æ ¼å¼æ¢è¡Œ
          MESSAGE="ğŸ“¢ *è‡ªåŠ¨æ›´æ–°å®Œæˆï¼*\\n\\næ—¶é—´ï¼š$NOW\\nè¿™é‡Œæ˜¯æœ€æ–°çš„ All.txt æ–‡ä»¶ï¼š"
          
          # å‘é€æ–‡æœ¬æ¶ˆæ¯
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="MarkdownV2" \
            -d text="$MESSAGE"

          # å‘é€æ–‡ä»¶
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument" \
            -F chat_id="$TELEGRAM_CHAT_ID" \
            -F document=@"$FILE" \
            -F caption="âœ… æœ€æ–° All.txt æ–‡ä»¶å·²å‘é€ï¼æ—¶é—´ï¼š$NOW"
