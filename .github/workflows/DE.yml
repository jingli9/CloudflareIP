name: DE

on:
  push:
  schedule:
    - cron: '0 */8 * * *'  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true

      - name: Run script and save output
        run: |
          python py/DE.py > DE.txt

      - name: Commit and push result (force)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add DE.txt
          git commit -m "Auto update DE.txt [skip ci]" || echo "No changes to commit"
          git push origin main --force

      - name: Send DE.txt to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          FILE="DE.txt"
          # è·å–åŒ—äº¬æ—¶é—´
          NOW=$(TZ="Asia/Shanghai" date "+%Y-%m-%d %H:%M:%S")

          # åˆ¤æ–­è§¦å‘æ–¹å¼
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            TRIGGER="æ‰‹åŠ¨è§¦å‘"
          elif [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
            TRIGGER="å®šæ—¶è§¦å‘"
          else
            TRIGGER="Push è§¦å‘"
          fi

          # HTML æ ¼å¼æ¶ˆæ¯
          MESSAGE="ğŸ“¢ <b>è‡ªåŠ¨æ›´æ–°å®Œæˆï¼</b><br>è§¦å‘æ–¹å¼ï¼š$TRIGGER<br>æ—¶é—´ï¼š$NOW<br>è¿™é‡Œæ˜¯æœ€æ–°çš„ DE.txt æ–‡ä»¶ï¼š"

          # ä½¿ç”¨ --data-urlencode é¿å…ç‰¹æ®Šå­—ç¬¦ç ´åæ¶ˆæ¯
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
            --data-urlencode "parse_mode=HTML" \
            --data-urlencode "text=$MESSAGE"

          # å‘é€æ–‡ä»¶
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument" \
            -F chat_id="$TELEGRAM_CHAT_ID" \
            -F document=@"$FILE" \
            -F caption="âœ… æœ€æ–° DE.txt æ–‡ä»¶å·²å‘é€ï¼æ—¶é—´ï¼š$NOW"
