name: Me  # æ”¹æˆ All / US / SG / JP / DE / Me

on:
  schedule:
    - cron: '0 */8 * * *'  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true

      - name: Run script and save output
        run: |
          python py/Me.py > Me.txt  # æ”¹æˆå¯¹åº”æ–‡ä»¶

      - name: Commit and push result (force)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Me.txt
          git commit -m "Auto update Me.txt [skip ci]" || echo "No changes to commit"
          git push origin main --force

      - name: Send Me.txt to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          FILE="Me.txt"
          # è·å–åŒ—äº¬æ—¶é—´
          NOW=$(TZ="Asia/Shanghai" date "+%Y-%m-%d %H:%M:%S")

          # åˆ¤æ–­è§¦å‘æ–¹å¼
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            TRIGGER="æ‰‹åŠ¨è§¦å‘"
          else
            TRIGGER="å®šæ—¶è§¦å‘"
          fi

          # HTML æ ¼å¼æ¶ˆæ¯ï¼ˆæ¢è¡Œ + ç²—ä½“ + emojiï¼‰
          MESSAGE="ğŸ“¢ <b>è‡ªåŠ¨æ›´æ–°å®Œæˆï¼</b><br>è§¦å‘æ–¹å¼ï¼š$TRIGGER<br>æ—¶é—´ï¼š$NOW<br>è¿™é‡Œæ˜¯æœ€æ–°çš„ $FILE æ–‡ä»¶ï¼š"

          # æ­£ç¡®å‘é€ HTML æ¶ˆæ¯
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"

          # å‘é€æ–‡ä»¶
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument" \
            -F chat_id="$TELEGRAM_CHAT_ID" \
            -F document=@"$FILE" \
            -F caption="âœ… æœ€æ–° $FILE æ–‡ä»¶å·²å‘é€ï¼æ—¶é—´ï¼š$NOW"
